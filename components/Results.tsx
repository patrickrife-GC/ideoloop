

import React, { useRef, useState, useEffect } from 'react';
import { GeneratedResult } from '../types';
import { ArrowDownTrayIcon, PhotoIcon } from '@heroicons/react/24/solid';

interface ResultsProps {
  result: GeneratedResult;
  recordings: Record<string, Blob>;
  videoUrl?: string; // fallback for cloud playback
  onRestart: () => void;
  isLoadingText?: boolean;
  onRetryImage?: (index: number) => void;
}

const TypeLabel = ({ type }: { type: string }) => {
  let colorClass = "bg-gray-100 text-gray-800";
  if (type === 'Tweet Thread') colorClass = "bg-blue-50 text-blue-700";
  if (type === 'Blog Post Intro') colorClass = "bg-orange-50 text-orange-700";
  if (type === 'LinkedIn Post') colorClass = "bg-blue-100 text-[#0077b5]";
  if (type === 'Video Hook') colorClass = "bg-purple-50 text-purple-700";

  return (
    <span className={`px-3 py-1 rounded-full text-sm font-semibold ${colorClass}`}>
      {type}
    </span>
  );
};

// Skeleton Loader
const SkeletonPulse = ({ className }: { className?: string }) => (
    <div className={`animate-pulse bg-gray-200 rounded ${className}`}></div>
);

export const Results: React.FC<ResultsProps> = ({
  result,
  recordings,
  videoUrl,
  onRestart,
  isLoadingText,
  onRetryImage
}) => {
  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text);
  };

  const downloadAudio = (blob: Blob | undefined, url: string | undefined, filename: string) => {
    const a = document.createElement('a');
    if (blob) {
        const objectUrl = URL.createObjectURL(blob);
        a.href = objectUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(objectUrl);
    } else if (url) {
        // Direct download for cloud files (browser handling)
        a.href = url;
        a.download = filename;
        a.target = '_blank';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
  };
  
  const downloadImage = (base64Url: string, filename: string) => {
      const a = document.createElement('a');
      a.href = base64Url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
  };

  return (
    <div className="min-h-screen bg-white py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-6xl mx-auto">
        <div className="mb-10 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
          <div>
            <h2 className="text-3xl font-bold text-gray-900">Here’s what we made…</h2>
            <p className="text-gray-500 mt-1">Generated by Ideoloop</p>
          </div>
          <div className="flex gap-3">
            {(recordings['full_session'] || videoUrl) && (
                <button 
                onClick={() => downloadAudio(recordings['full_session'], videoUrl, `ideoloop_audio_${Date.now()}.webm`)}
                className="flex items-center gap-2 text-gray-600 hover:text-gray-900 text-sm font-semibold border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors"
                >
                <ArrowDownTrayIcon className="w-4 h-4" />
                Download Audio
                </button>
            )}
            <button 
                onClick={onRestart}
                className="text-[#1f3a2e] hover:text-[#5a7968] text-sm font-semibold border border-[#1f3a2e] px-4 py-2 rounded-lg hover:bg-[#1f3a2e]/10 transition-colors"
            >
                Start New
            </button>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
          {/* Left Column: Transcription */}
          <div className="lg:col-span-4">
            <div className="bg-gray-50 rounded-xl p-6 border border-gray-100 sticky top-6">
              <h3 className="text-sm font-bold uppercase tracking-wider text-gray-400 mb-4">Transcript Summary</h3>
              {isLoadingText ? (
                  <div className="space-y-3">
                      <SkeletonPulse className="w-full h-4" />
                      <SkeletonPulse className="w-full h-4" />
                      <SkeletonPulse className="w-2/3 h-4" />
                      <SkeletonPulse className="w-full h-4" />
                  </div>
              ) : (
                <div className="prose prose-sm max-h-[600px] overflow-y-auto pr-2 scrollbar-hide text-gray-600 leading-relaxed font-light">
                    {result.transcription}
                </div>
              )}
            </div>
          </div>

          {/* Right Column: Generated Text & Image Assets */}
          <div className="lg:col-span-8 space-y-8">
            {isLoadingText ? (
                [1,2,3].map(i => (
                    <div key={i} className="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm p-8">
                         <div className="flex justify-between mb-6">
                             <SkeletonPulse className="w-24 h-6 rounded-full" />
                             <SkeletonPulse className="w-16 h-6" />
                         </div>
                         <div className="space-y-4">
                             <SkeletonPulse className="w-full h-4" />
                             <SkeletonPulse className="w-full h-4" />
                             <SkeletonPulse className="w-3/4 h-4" />
                             <SkeletonPulse className="w-full h-4" />
                             <SkeletonPulse className="w-1/2 h-4" />
                         </div>
                    </div>
                ))
            ) : (
                result.socialAssets && result.socialAssets.map((asset, idx) => (
                <div key={idx} className="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                    <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                        <TypeLabel type={asset.type} />
                        <button
                            onClick={() => copyToClipboard(asset.content)}
                            className="text-xs font-medium text-gray-500 hover:text-gray-900 px-3 py-1 rounded hover:bg-gray-100"
                        >
                            Copy Text
                        </button>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 p-8">
                        {/* Text Content */}
                        <div className={asset.imageUrl ? "" : "md:col-span-2"}>
                            <div className="text-gray-800 whitespace-pre-wrap leading-relaxed font-normal text-lg">
                                {asset.content}
                            </div>
                            {asset.hashtags && asset.hashtags.length > 0 && (
                                <div className="mt-6 flex flex-wrap gap-2 pt-4 border-t border-gray-100">
                                {asset.hashtags.map((tag, i) => (
                                    <span key={i} className="text-gray-400 text-sm">{tag.startsWith('#') ? tag : `#${tag}`}</span>
                                ))}
                                </div>
                            )}
                        </div>

                        {/* Generated Image */}
                        {asset.imageUrl && (
                            <div className="flex flex-col gap-2">
                                <div className="rounded-lg overflow-hidden border border-gray-100 shadow-sm relative group">
                                    <img src={asset.imageUrl} alt="AI Generated" className="w-full h-auto object-cover" />
                                    <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                        <button 
                                            onClick={() => asset.imageUrl && downloadImage(asset.imageUrl, `ideoloop_image_${idx}.png`)}
                                            className="bg-white text-gray-900 px-4 py-2 rounded-full font-bold text-sm shadow-lg flex items-center gap-2 transform hover:scale-105 transition-transform"
                                        >
                                            <ArrowDownTrayIcon className="w-4 h-4" />
                                            Download Image
                                        </button>
                                    </div>
                                </div>
                                <div className="text-[10px] text-gray-400 flex items-center gap-1">
                                    <PhotoIcon className="w-3 h-3" />
                                    Generated by Gemini Nano Banana
                                </div>
                            </div>
                        )}
                        
                        {!asset.imageUrl && asset.imagePrompt && asset.imageStatus !== "failed" && (
                             <div className="md:col-span-1 border border-dashed border-gray-200 rounded-lg flex items-center justify-center bg-gray-50 p-6">
                                 <p className="text-xs text-gray-400 text-center animate-pulse">Generating visual...</p>
                             </div>
                        )}

                        {!asset.imageUrl && asset.imagePrompt && asset.imageStatus === "failed" && (
                             <div className="md:col-span-1 border border-dashed border-red-200 rounded-lg flex flex-col items-center justify-center bg-red-50 p-6 gap-3">
                                 <p className="text-xs text-red-600 text-center">
                                   {asset.imageError || "Image generation failed."}
                                 </p>
                                 {onRetryImage && (
                                   <button
                                     onClick={() => onRetryImage(idx)}
                                     className="text-xs font-semibold text-red-700 underline underline-offset-4 hover:text-red-900"
                                   >
                                     Retry image
                                   </button>
                                 )}
                             </div>
                        )}
                    </div>
                </div>
                ))
            )}
          </div>
        </div>
      </div>
    </div>
  );
};
